<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>FCK AFD Image Blender</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f8dfd5;
      margin: 0; 
      padding: 0; 
      text-align: center;
    }
    h1 {
      margin: 20px 0;
    }
    #dropZone {
      margin: 20px auto;
      width: 300px;
      height: 200px;
      background-color: #f2bca2;
      border: 2px dashed #da8f6b;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #dropZone.hover {
      background-color: #f7cbb7;
    }
    #dropZone p {
      max-width: 80%;
      font-size: 16px;
      color: #7b3f2f;
    }
    #processButton {
      margin-top: 10px;
      padding: 10px 20px;
      background: #b84b37;
      color: #fff;
      border: none;
      cursor: pointer;
      display: none;
    }
    #iconContainer {
      margin: 30px auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      max-width: 600px;
    }
    .overlayIcon {
      width: 100px;
      height: 100px;
      object-fit: cover;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border 0.3s;
    }
    .overlayIcon.selected {
      border: 2px solid #b84b37;
    }
    #preview {
      margin: 20px auto;
      width: 300px;
      height: auto;
      display: none;
      border: 1px solid #ccc;
    }
    canvas {
      display: none;
    }
  </style>
</head>
<body>
  <h1>FCK AFD Image Blender</h1>

  <!-- Drag & Drop / Upload-Box -->
  <div id="dropZone">
    <p id="dropZoneText">Lass es fallen, als ob es heiß wäre.<br />(Oder klicke hier zum Auswählen.)</p>
  </div>
  <button id="processButton">Mischen &amp; Download</button>

  <!-- Vorschau (Dummybild) -->
  <img id="preview" src="dummy.png" alt="Bildvorschau" />

  <!-- Overlays -->
  <div id="iconContainer">
    <img src="Icon1.png" class="overlayIcon" data-icon="Icon1.png" alt="Overlay 1" />
    <img src="Icon2.png" class="overlayIcon" data-icon="Icon2.png" alt="Overlay 2" />
    <img src="Icon3.png" class="overlayIcon" data-icon="Icon3.png" alt="Overlay 3" />
    <img src="Icon4.png" class="overlayIcon" data-icon="Icon4.png" alt="Overlay 4" />
    <img src="Icon5.png" class="overlayIcon" data-icon="Icon5.png" alt="Overlay 5" />
  </div>

  <!-- Verstecktes File-Input -->
  <input type="file" id="fileInput" accept="image/*" style="display: none;" />

  <!-- Canvas -->
  <canvas id="canvas"></canvas>

  <script>
    const dropZone = document.getElementById('dropZone');
    const dropZoneText = document.getElementById('dropZoneText');
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const processButton = document.getElementById('processButton');
    const overlayIcons = document.querySelectorAll('.overlayIcon');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    let uploadedImage = null;
    let selectedOverlaySrc = null;

    // -- Drag & Drop Event-Listener -------------------------------------------
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('hover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('hover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('hover');
      if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
        handleFile(e.dataTransfer.files[0]);
      }
    });

    // Klick auf Dropzone öffnet FileDialog
    dropZone.addEventListener('click', () => {
      fileInput.click();
    });

    fileInput.addEventListener('change', () => {
      if (fileInput.files && fileInput.files.length > 0) {
        handleFile(fileInput.files[0]);
      }
    });

    // -- Datei verarbeiten und Bild laden -------------------------------------
    function handleFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        uploadedImage = new Image();
        uploadedImage.onload = () => {
          preview.src = e.target.result;
          preview.style.display = 'block';
          dropZone.style.display = 'none';
          processButton.style.display = 'inline-block'; // Button anzeigen
        };
        uploadedImage.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    // -- Overlay-Icons-Klick verarbeiten -------------------------------------
    overlayIcons.forEach(icon => {
      icon.addEventListener('click', () => {
        // Zuvor ausgewählte markieren entfernen
        overlayIcons.forEach(i => i.classList.remove('selected'));
        icon.classList.add('selected');

        selectedOverlaySrc = icon.dataset.icon;
      });
    });

    // -- Button: Mischen & Download -------------------------------------------
    processButton.addEventListener('click', () => {
      if (!uploadedImage) {
        alert('Bitte erst ein Bild hochladen!');
        return;
      }
      if (!selectedOverlaySrc) {
        alert('Bitte ein Overlay auswählen!');
        return;
      }
      // Mischen
      combineImages(uploadedImage, selectedOverlaySrc);
    });

    // -- Bilder kombinieren ---------------------------------------------------
    function combineImages(baseImage, overlaySrc) {
      const overlayImg = new Image();
      overlayImg.onload = () => {
        // Canvas-Größe an das Basisbild anpassen
        canvas.width = baseImage.width;
        canvas.height = baseImage.height;

        // 1) Basisbild normal zeichnen
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.globalCompositeOperation = 'source-over';
        ctx.drawImage(baseImage, 0, 0, canvas.width, canvas.height);

        // 2) Overlay mit "soft-light"-Modus drauf
        ctx.globalCompositeOperation = 'soft-light';
        ctx.drawImage(overlayImg, 0, 0, canvas.width, canvas.height);

        // 3) aus Canvas ein Data-URL erstellen
        const dataURL = canvas.toDataURL('image/png');

        // 4) Download anstoßen
        downloadImage(dataURL, 'FCK_AFD_Blend.png');

        // 5) Ggf. hochgeladenes Bild "vergessen"
        // (im reinen Frontend kann man nur versuchen, die Variable zu leeren)
        uploadedImage = null;
        preview.style.display = 'none';
        preview.src = 'dummy.png';
        dropZone.style.display = 'flex';
        processButton.style.display = 'none';
        overlayIcons.forEach(i => i.classList.remove('selected'));
        selectedOverlaySrc = null;
      };
      overlayImg.src = overlaySrc;
    }

    // -- Helper: Download-Funktion -------------------------------------------
    function downloadImage(data, filename) {
      const a = document.createElement('a');
      a.href = data;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  </script>
</body>
</html>
